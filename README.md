_ЛК &#xab;ЭнергосбыТ+&#xbb;_ для _Home Assistant_
==================================================

<img src="https://raw.githubusercontent.com/g470258/hass-esplus/refs/heads/main/images/header.png" alt="Логотип интеграции">

> Предоставление информации о текущем состоянии ваших лицевых счетов в ЛК ЭнергосбыТ Плюс.
> Передача показаний по счётчикам.
>
>
> [![hacs_badge](https://img.shields.io/badge/HACS-Default-41BDF5.svg?style=for-the-badge)](https://github.com/custom-components/hacs)
> [![Лицензия](https://img.shields.io/badge/%D0%9B%D0%B8%D1%86%D0%B5%D0%BD%D0%B7%D0%B8%D1%8F-MIT-yellow.svg?style=for-the-badge)](https://opensource.org/licenses/MIT)



## Скриншоты

<details>
  <summary>Информация о лицевом счёте</summary> 
  <img src="https://raw.githubusercontent.com/g470258/hass-esplus/main/images/account.png" alt="Скриншот: Информация о лицевом счёте">
</details>
<details>
  <summary>Общие начисления</summary> 
  <img src="https://raw.githubusercontent.com/g470258/hass-esplus/main/images/charges.png" alt="Скриншот: Общие начисления">
</details>
<details>
  <summary>Начисления по услуге</summary> 
  <img src="https://raw.githubusercontent.com/g470258/hass-esplus/main/images/service_charges.png" alt="Скриншот: Начисления по услуге">
</details>
<details>
  <summary>Последний зарегистрированный платёж</summary> 
  <img src="https://raw.githubusercontent.com/g470258//hass-esplus/main/images/last_payment.png" alt="Скриншот: Последний зарегистрированный платёж">
</details>
<details>
  <summary>Счётчик коммунальных услуг</summary> 
  <img src="https://raw.githubusercontent.com/g470258/hass-energosbyt-t-plus/main/images/meter.png" alt="Скриншот: Счётчик коммунальных услуг">
</details>
<details>
  <summary>Служба отправки показаний</summary> 
  <img src="https://raw.githubusercontent.com/g470258/hass-esplus/main/images/push_indications_service.png" alt="Скриншот: Служба отправки показаний">
</details>

## Установка

1. Установите
   HACS ([инструкция по установке на оф. сайте](https://hacs.xyz/docs/installation/installation/))
1. Найдите `ЛК ЭнергосбыТ+` в поиске по интеграциям <sup>1</sup>
1. Установите последнюю версию компонента, нажав на кнопку `Установить` 
1. Перезапустите Home Assistant

## Конфигурация компонента:
- Вариант А: Через _Интеграции_ (в поиске - "ЛК ЭнергосбыТ+") - рекомендуемый способ
- Вариант Б: YAML

### Пример конфигурации YAML
```yaml
...
esplus:
  # Выбран филиал в г. Киров
  branch: kirov
  username: 1234567890
  password: super_password
```


### Описание конфигурационной схемы
```yaml
...
esplus:
  
  # Филиал / регион
  # Доступные филиалы на момент релиза:
  # - vladimir: Владимирский филиал
  # - ivanovo: Ивановский филиал
  # - kirov: Кировский филиал
  # - chuvashia: Филиал Марий Эл и Чувашии
  # - oren: Оренбургский филиал
  # - samara: Самарский филиал
  # - saratov: Саратовский филиал
  # - ekb: Свердловский филиал (Екатеринбург)
  # - udm: Удмуртский филиал
  # - ulyanov: Ульяновский филиал
  branch: "..."

  # Имя пользователя (номер лицевого счёта)
  # Обязательный параметр
  username: "..."

  # Пароль
  # Обязательный параметр
  password: "..."

  # Конфигурация по умолчанию для лицевых счетов
  # Необязательный параметр
  #  # Данная конфигурация применяется, если отсутствует  # конкретизация, указанная в разделе `accounts`.
  default:

    # Добавлять ли объект(-ы): Информация о лицевом счёте
    # Значение по умолчанию: истина (true)
    accounts: true | false

    # Добавлять ли объект(-ы): Счётчик коммунальных услуг
    # Значение по умолчанию: истина (true)
    meters: true | false

    # Добавлять ли объект(-ы): Последний зарегистрированный платёж
    # Значение по умолчанию: истина (true)
    last_payment: true | false
    
    # Добавлять ли объект(-ы): Общие начисления
    # Значение по умолчанию: истина (true)
    charges: true | false
    
    # Добавлять ли объект(-ы): Начисления по услугам
    # Значение по умолчанию: истина (true)
    service_charges: true | false
    
    # Скрытие персональных данных
    #
    # Внимание! Данный параметр является техническим, и используется исключительно для
    # разработки и создания скриншотов (например, для тикетов). Его использование не
    # рекомендовано! Данный параметр не скрывает Ваши личные данные из логов.
    #
    # Значение по умолчанию: ложь (false)
    dev_presentation: true | false

  # Настройки для отдельных лицевых счетов
  # Необязательный параметр
  accounts:

    # Номер лицевого счёта
    "...":

      # Конфигурация по конкретным лицевым счетам выполняется аналогично
      # конфигурации по умолчанию для лицевых счетов (раздел `default`).
      ...
```

### Вариант конфигурации "Чёрный список"

Для реализации белого списка, конфигурация выполняется следующим образом:
```yaml
...
esplus:
  ...
  # Выборочное исключение лицевых счетов
  accounts:
    # Все указанные ниже лицевые счета будут добавлены
    "123123123000": false
    "321321321000": false
    "333222111001": false
```

### Вариант конфигурации "Белый список"

Для реализации белого списка, конфигурация выполняется следующим образом:
```yaml
...
esplus:
  ...
  # Отключение добавление лицевых счетов по умолчанию
  default: false

  # Выборочное включение лицевых сченов
  accounts:
    # Все указанные ниже лицевые счета будут добавлены
    "123123123000": true
    "321321321000": true
    "333222111001": true
```

Также возможно использовать укороченную запись:
```yaml
...
esplus:
  ...
  # Данный пример функционально эквивалентен предыдущему примеру
  default: false
  accounts: ["123123123000", "321321321000", "333222111001"]
```

## Использование

### Служба передачи показаний - `esplus.push_indications`

Служба передачи показаний позволяет отправлять показания по счётчикам в личный кабинет, и
имеет следующий набор параметров:

| Название | Описание |
| --- | --- |
| `target` | Выборка целевых объектов, для которых требуется передавать показания |
| `data`.`indications` | Список / именованный массив показаний, передаваемых в ЛК |
| `data`.`incremental` | Суммирование текущих показаний с передаваемыми |
| `data`.`ignore_period` | Игнорировать период передачи показаний |
| `data`.`ignore_indications` | Игнорировать ограничения по значениям |

#### Примеры вызова службы

##### 1. Обычная передача показаний

- Например, если передача показаний активна с 15 по 25 число, а сегодня 11, то показания
  <font color="red">**не будут**</font> отправлены<sup>1</sup>.
- Например, если текущие, последние или принятые значения по счётчику &ndash; 321, 654 и 987 по зонам
  _Т1_, _Т2_ и _Т3_ соответственно, то показания <font color="red">**не будут**</font>
  отправлены<sup>1</sup>.
  
```yaml
action: esplus..push_indications
data:
  indications: "123, 456, 789"
target:
  entity_id: sensor.1243145122_meter_123456789
```

... или, с помощью именованного массива:

```yaml
action: esplus..push_indications
data:
  indications:
    t1: 123
    t2: 456
    t3: 789
target:
  entity_id: sensor.1243145122_meter_123456789
```

... или, с помощью списка:

```yaml
action: esplus..push_indications
data:
  indications: [123, 456, 789]
target:
  entity_id: sensor.1243145122_meter_123456789
```

##### 2. Форсированная передача показаний

Отключение всех ограничений по показаниям.

- Например, если передача показаний активна с 15 по 25 число, а сегодня 11, то показания
  <font color="green">**будут**</font> отправлены<sup>1</sup>.
- Например, если текущие, последние или принятые значения по счётчику &ndash; 321, 654 и 987 по зонам
  _Т1_, _Т2_ и _Т3_ соответственно, то показания <font color="green">**будут**</font>
  отправлены<sup>1</sup>.
  
```yaml
action: esplus..push_indications
data:
  indications: [123, 456, 789]
  ignore_indications: true
  ignore_periods: true
target:
  entity_id: sensor.1243145122_meter_123456789
```

##### 3. Сложение показаний

- Например, если передача показаний активна с 15 по 25 число, а сегодня 11, то показания
  <font color="red">**не будут**</font> отправлены<sup>1</sup>.
- Например, если текущие, последние или принятые значения по счётчику &ndash; 321, 654 и 987 по зонам
  _Т1_, _Т2_ и _Т3_ соответственно, то показания <font color="green">**будут**</font>
  отправлены<sup>1</sup>.
  
**Внимание:** в данном примере будут отправлены показания _444_, _1110_ и _1776_,
а не _123_, _456_ и _789_. 
  
```yaml
action: esplus.push_indications
data:
  indications: [123, 456, 789]
  incremental: true
target:
  entity_id: sensor.1243145122_meter_123456789
```
##### 4. Уведомление об отправке
Два варианта(можно использовать одновременно):
- Создание persistent_notification(Уведомления в ХА).
- Отправке уведомления через сервисы notify.*(например, telegram, mobile_app_XXX).
```yaml
action: esplus.push_indications
data:
  indications: [123, 456, 789]
  notification: true   #создание persistent_notification
  notification_service: telegram_gleb #отправка в сервис notify.telegram_gleb
target:
  entity_id: sensor.1243145122_meter_123456789
```
